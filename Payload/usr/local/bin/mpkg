#!/bin/bash
args=$1
pkg=$2
ROOTFS="/"
LIBRARY="/usr/local/mpkglib"
BINARY=$LIBRARY"/binary"
LIST=$LIBRARY/cache/selectedPKGList

RED='\033[0;31m'
GRN='\033[0;32m'
YEL='\033[0;33m'
BLU='\033[0;34m'
NC='\033[0m'
if [[ "$pkg" == ":selected" ]]; then
	declare -i loopset=$(wc -l < $LIST)
	declare -i loopProgress=0
	echo "Total selected:" $loopset
	while [[ $loopset -gt $loopProgress ]]; do
		loopProgress=$(( $loopProgress + 1 ))
		if [[ $args == "-i" ]] || [[ $args == "--install" ]]; then
			sudo $BINARY/mpkg-install "$(awk -v line=$loopProgress 'NR==line' $LIST)" "$3" "$4" "$5" "$6" "@@@@pkgsAreFromSelected"
		elif [[ $args == "-r" ]] || [[ $args == "--remove" ]]; then
			sudo $BINARY/mpkg-remove "$(awk -v line=$loopProgress 'NR==line' $LIST)" "$3" "@@@@pkgsAreFromSelected"
		elif [[ $args == "-b" ]] || [[ $args == "--block-remove" ]]; then
			sudo $BINARY/mpkg-blockremove "$(awk -v line=$loopProgress 'NR==line' $LIST)" "@@@@pkgsAreFromSelected"
		fi
	done
	$BINARY/mpkg-select "--clear"
elif [[ -z $args ]]; then
	$BINARY/mpkg-manual
	exit
elif [[ $args == "-i" ]] || [[ $args == "--install" ]]; then
	sudo $BINARY/mpkg-install "$pkg" "$3" "$4" "$5" "$6"
	exit
elif [[ $args == "-r" ]] || [[ $args == "--remove" ]]; then
	sudo $BINARY/mpkg-remove "$pkg" "$3"
	exit
elif [[ $args == "-h" ]] || [[ $args == "--help" ]]; then
	$BINARY/mpkg-manual
	exit
elif [[ $args == "-b" ]] || [[ $args == "--block-remove" ]]; then
	sudo $BINARY/mpkg-blockremove "$pkg" "$3"
elif [[ $args == "--force-unlock" ]]; then
	echo "Forcing mpkg unlock..."
	sudo rm $LIBRARY/lock
	echo -e "${GRN}Done.${NC}"
	exit
elif [[ $args == "-v" ]] || [[ $args == "--version" ]]; then
	echo "Macintosh Packager"
	echo "Version "$(<$LIBRARY/db/mpkg/version)
	exit
elif [[ $args == "-p" ]] || [[ $args == "--package-inspect" ]]; then
	$BINARY/mpkg-grabinfo "$pkg"
elif [[ $args == "-l" ]] || [[ $args == "--list" ]]; then
	ls $LIBRARY/db
	exit
elif [[ $args == "-m" ]] || [[ $args == "--make" ]]; then
	$BINARY/mpkg-make "$pkg" "$3" "$4"
elif [[ $args == "-c" ]] || [[ $args == "--create" ]]; then
	$BINARY/mpkg-create "$pkg" "$3"
elif [[ $args == "-d" ]] || [[ $args == "--deploy" ]]; then
	sudo $BINARY/mpkg-deploy $USER "$pkg" "$3" "$4"
elif [[ $args == "--upgrade" ]]; then
	sudo $BINARY/mpkg-upgrade
elif [[ $args == "--select" ]]; then
	sudo $BINARY/mpkg-select $2 $3 $4 $5 $6 $7 $8 $9
elif [[ $args == "fullmpkgerase" ]]; then
	sudo $BINARY/mpkg-erase $2
else
	$LIBRARY/binary/mpkg-manual
	exit
fi
